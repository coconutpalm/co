<!DOCTYPE html>
  <head> 

  </head>
<body>
<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="public/lib/codemirror.js"></script>

<link rel="stylesheet" href="public/lib/codemirror.css">
<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>


<style>
.other {
  color: "#7f00ff";
}
</style>
<div id="anchor"> </div>

<script src="public/elm.js"></script>
<script>

var url = window.location.href;
var final_url = url.substr(url.lastIndexOf('/') + 1);
console.log(final_url);
var peer;
var peer_id;
var fellow_ids = {}, connections = [];

$(document).ready(function(e){


handleData = function(data){
  console.log("update from: ", data.peer_id);
  if (data === undefined){
    return;
  }
  if (data.data_type === "member_update") {
    for (key in data.members) {
      fellow_ids[key] = true;
      console.log("adding", key);
    }
    console.log("members after update: ", fellow_ids);

  }


}


handleConnection = function(conn) {
  //console.log("handle connect: ", conn);
  conn.on('open', function (){

      console.log("connected with peer: ", conn.peer);

      initialData = {
        peer_id: peer_id,
        members: fellow_ids,
        data_type: "member_update"

      };


      conn.send(initialData);
      console.log("sending: ", initialData);

      conn.on('data', function(data){
          handleData(data);

      });

  })

}


  //console.log("e is ", e);
  // e.preventDefault();

  $.ajax({url: "/docs/" + final_url, success: function(result) {

          //console.log("success!! ", result);

          var peer_info = JSON.parse(result);
          peer_id = peer_info.doc_id.toString() + "-"+ peer_info.site_id.toString();
          peer = new Peer(peer_id, {host: 'localhost', port: 9000, path: '/myapp'});

          console.log("peer is", peer_id);

          //fellow_ids = peer_info.members;
          //console.log("fellows is", fellow_ids);
          if (peer === undefined || fellow_ids === undefined) {
            return;
          }
          var connections = [];
          for (var i = 0; i < peer_info.members.length; i++) {
            var fellow_id = peer_info.doc_id.toString() + "-" + peer_info.members[i].toString();
            //fellow_ids.push(fellow_id);
            fellow_ids[fellow_id] = true;
            if (fellow_id === peer_id) {
              continue;
            }

            var conn = peer.connect(fellow_id);
            connections.push(conn);
            handleConnection(conn);

          }

      peer.on('connection',function(conn){  
         handleConnection(conn);  
        });

          // now you want to message all your peers telling them that you have 

        } 
  });





});








var div = document.getElementById('anchor');
var woot = Elm.embed(Elm.TUpdate, div, {tUpdatePort: JSON.stringify({"type": "Insert", "cp": 1, "ch": "a"})
                    , windowLocPort: window.location.origin});
var textAreaOld = document.getElementById('TUpdateZone');
var textArea = CodeMirror(document.body)
var colors = ["#80ff00", "#7f00ff", "#ff8000"];
var userColors = {};
textArea.on("change", function (i, c){
  console.log("omg! ", c);
  if (c.origin != "+input" && c.origin != "+delete" && c.origin != "paste"){
    return;
  }
  var toSend = {};
  var cursor = textArea.getCursor();
  var cp = textArea.indexFromPos(cursor);
  if (c.origin === "paste") {
    toSend["type"] = "InsertString";
    toSend["str"] = c.text[0];
    cp = textArea.indexFromPos(c.from) + 1;
  }
  else if (c.removed[0] != ""){
    toSend["type"] = "Delete";
    currString = textArea.getValue();
    toSend["ch"] = c.removed[0]
  }
  else if (c['text'][0] != ""){
      toSend["type"] = "Insert";
      console.log("letter", c.text[0]);
      toSend["ch"] = c.text[0];
      cp = cp - 1;
  }
  else if (c['text'].length === 2){
      toSend["type"] = "Insert";
      toSend["ch"] = "\n";
  }
  toSend.cp = cp;
  console.log("tosend is", toSend);
  //doc.markText(from: {line, ch}, to: {line, ch}, ?options: object) â†’ TextMarker
  textArea.markText
  woot.ports.tUpdatePort.send(JSON.stringify(toSend));
 
});
/// to do !! figure out an easy way to get an event when the USER deletes something from the text area.. not if it's programmatically deleted
woot.ports.docUpdatesPort.subscribe(docUpdate);
function docUpdate(str){
  var docUpdates = JSON.parse(str);
  //console.log("REGISTERING server Update", docUpdates);
  if (docUpdates === undefined || docUpdates.length === 0){
    return;
  }
  for (var i = 0; i< docUpdates.length; i++ ) {
    var docUpdate = docUpdates[i];
  
  if (docUpdate["type"] === "typingInsert" ){
    if (docUpdate["ch"] === undefined || docUpdate["index"] === undefined){
      return;
    }
    var location = docUpdate["index"];
    var from = textArea.posFromIndex(location);
    textArea.replaceRange(docUpdate["ch"], from, null, "server!!!");
    var to = textArea.posFromIndex(location + 1);
    console.log("from", from, "to", to);
    textArea.markText(from, to, {css: "color: blue"});
    updateCaret("insert");
  }
  else if (docUpdate["type"] === "typingDelete"){
    if (docUpdate["ch"] === undefined || docUpdate["index"] === undefined){
      return;
    }
    var location = docUpdate["index"];
    var from = textArea.posFromIndex(location)
    var to = textArea.posFromIndex(location + 1)
    textArea.replaceRange("", from, to, "server!!!");
    updateCaret("delete");
  }
}
}
function updateCaret(action){
  var update;
  if (action === "insert"){
    update = function(x) {return x + 1;};
  } else if (action === "delete") {
    update = function(x){return x - 1};
  }
  var caret = textArea.indexFromPos(textArea.getCursor());
  var newCaret = caret;
  if (caret > location) {
      newCaret = update(caret);
  }
  textArea.setCursor(textArea.posFromIndex(newCaret));
}
woot.ports.sendNewStringUpdatesPort.subscribe(stringUpdate);
function stringUpdate(str){

}
setInterval(function(){
  console.log(textArea.indexFromPos(textArea.getCursor()))
}, 500);
var sendUpdate = function(){
    if (woot === undefined 
      || woot.ports === undefined 
      || textArea === undefined 
      || textArea.value === undefined) 
    {
      return
    }
  var currString = textArea.value;
  var cp = textArea.indexFromPos(textArea.getCursor);
  var toSend = {len: currString.length
                , cp: cp
                , str: currString}
  woot.ports.TUpdatePort.send(toSend);
}
getCaretPosition = function(){

}
</script>
</body>
</html>
