<!DOCTYPE html>
  <head> 
  </head>
<body>
<script src="public/lib/codemirror.js"></script>
<link rel="stylesheet" href="public/lib/codemirror.css">
<div id="anchor"> </div>
<textarea id="TUpdateZone"></textarea>

<script src="public/elm.js"></script>
<script>
var div = document.getElementById('anchor');
var woot = Elm.embed(Elm.TUpdate, div, {tUpdatePort: JSON.stringify({"type": "Insert", "cp": 1, "ch": "a"})
										, windowLocPort: window.location.origin});
var textAreaOld = document.getElementById('TUpdateZone');
var textArea = CodeMirror.fromTextArea(textAreaOld);

textArea.on("change", function (i, c){
		console.log("omg!!", c);

	if (c.origin != "+input" && c.origin != "+delete"){
		return;
	}

	var toSend = {};
	var cp = textArea.indexFromPos(textArea.getCursor());

	if (c.removed[0] != ""){
		toSend["type"] = "Delete";
		currString = textArea.getValue();
		toSend["ch"] = c.removed[0]
	}
	if (c['text'][0] != ""){
		toSend["type"] = "Insert";
		toSend["ch"] = c.text[0]
	}
	toSend.cp = cp;


	console.log("tosend is", toSend);

	woot.ports.tUpdatePort.send(JSON.stringify(toSend));
});


/// to do !! figure out an easy way to get an event when the USER deletes something from the text area.. not if it's programmatically deleted




woot.ports.docUpdatesPort.subscribe(docUpdate);

function docUpdate(str){
	var docUpdate = JSON.parse(str);

	console.log("doc update", docUpdate);
	if (docUpdate === undefined || docUpdate["type"] === undefined){
		return;
	}
	
	if (docUpdate["type"] === "typingInsert" ){
		if (docUpdate["ch"] === undefined || docUpdate["index"] === undefined){
			return;
		}

		var location = docUpdate["index"];
		var from = textArea.posFromIndex(location)
		textArea.replaceRange(docUpdate["ch"], from, null, "server!!!");//////*****
	}
	else if (docUpdate["type"] === "typingDelete"){
		if (docUpdate["ch"] === undefined || docUpdate["index"] === undefined){
			return;
		}
		var location = docUpdate["index"];
		var from = textArea.posFromIndex(location)
		var to = textArea.posFromIndex(location + 1)
		console.log("should be deleteing", from, " ", to);
		textArea.replaceRange("", from, to, "server!!!");


	}

}


woot.ports.sendNewStringUpdatesPort.subscribe(stringUpdate);

function stringUpdate(str){

	//console.log("got string update!!!");
	//var stringUpdate = JSON.parse(str);
	//console.log(stringUpdate);
	//textArea.setValue(stringUpdate.string);

	///sendNewStringUpdatesPort

}



var sendUpdate = function(){
    if (woot === undefined 
    	|| woot.ports === undefined 
    	|| textArea === undefined 
    	|| textArea.value === undefined) 
    {
    	return
    }
	var currString = textArea.value;
	var cp = textArea.indexFromPos(textArea.getCursor);


	var toSend = {len: currString.length
								, cp: cp
								, str: currString}
	woot.ports.TUpdatePort.send(toSend);
}



getCaretPosition = function(){
	if (textArea === undefined || textArea === []) {
		console.log("text area is", textArea);
		return;
	}
	var pos = 0;
    if (document.selection) {
    	textArea.focus ();
    	var Sel = document.selection.createRange();
    	var SelLength = document.selection.createRange().text.length;
    	Sel.moveStart ('character', -textArea.value.length);
    	pos = Sel.text.length - SelLength;
    }
    //Firefox support
    else if (textArea.selectionStart || textArea.selectionStart == '0')
    	pos = textArea.selectionStart;
    return pos;
}





woot.ports.sendCaretUpdatesPort.subscribe(caretUpdate);

function caretUpdate(cp){

	console.log("got caret update!!!", JSON.parse(cp));
	cp = JSON.parse(cp);
	if (cp != undefined && cp["type"] != undefined && cp["type"] === "Caret"){
		if (cp['pos'] != undefined){
			console.log("caret before: ", getCaretPosition());
			//textArea.setSelectionRange(cp.pos, cp.pos)
			console.log("caret after:", getCaretPosition());
		}
	}

}




</script>
</body>
</html>