<!DOCTYPE html>
  <head> 
  </head>
<body>
<script src="public/lib/codemirror.js"></script>
<link rel="stylesheet" href="public/lib/codemirror.css">
<style>
.other {
  color: "#7f00ff";
}
</style>
<div id="anchor"> </div>
<textarea id="TUpdateZone"></textarea>

<script src="public/elm.js"></script>
<script>
var div = document.getElementById('anchor');
var woot = Elm.embed(Elm.TUpdate, div, {tUpdatePort: JSON.stringify({"type": "Insert", "cp": 1, "ch": "a"})
                    , windowLocPort: window.location.origin});
var textAreaOld = document.getElementById('TUpdateZone');
var textArea = CodeMirror.fromTextArea(textAreaOld);
var colors = ["#80ff00", "#7f00ff", "#ff8000"];
var userColors = {};
textArea.on("change", function (i, c){
  console.log("omg! ", c);
      console.log("omg!!", c);
  if (c.origin != "+input" && c.origin != "+delete"){
    return;
  }
  var toSend = {};
  var cursor = textArea.getCursor();
  var cp = textArea.indexFromPos(cursor);
  if (c.removed[0] != ""){
    toSend["type"] = "Delete";
    currString = textArea.getValue();
    toSend["ch"] = c.removed[0]
  }
  if (c['text'][0] != ""){
          toSend["type"] = "Insert";
      console.log("letter", c.text[0]);
      toSend["ch"] = c.text[0]
  }
  else if (c['text'].length === 2){
        toSend["type"] = "Insert";
      console.log("ENTER!!!");
      toSend["ch"] = "\n";
  }
  toSend.cp = cp;
  console.log("tosend is", toSend);
  //doc.markText(from: {line, ch}, to: {line, ch}, ?options: object) â†’ TextMarker
  textArea.markText
  woot.ports.tUpdatePort.send(JSON.stringify(toSend));
 
});
/// to do !! figure out an easy way to get an event when the USER deletes something from the text area.. not if it's programmatically deleted
woot.ports.docUpdatesPort.subscribe(docUpdate);
function docUpdate(str){
  var docUpdates = JSON.parse(str);
  console.log("REGISTERING server Update", docUpdate);
  if (docUpdates === undefined || docUpdates.length === 0){
    return;
  }
  var docUpdate = docUpdates[0];
  
  if (docUpdate["type"] === "typingInsert" ){
    if (docUpdate["ch"] === undefined || docUpdate["index"] === undefined){
      return;
    }
    var location = docUpdate["index"];
    var from = textArea.posFromIndex(location);
    textArea.replaceRange(docUpdate["ch"], from, null, "server!!!");//////*****
    
    var to = textArea.posFromIndex(location + 1);
    textArea.markText(from, to, {css: {color: colors[0]}});
    updateCaret("insert");
  }
  else if (docUpdate["type"] === "typingDelete"){
    if (docUpdate["ch"] === undefined || docUpdate["index"] === undefined){
      return;
    }
    var location = docUpdate["index"];
    var from = textArea.posFromIndex(location)
    var to = textArea.posFromIndex(location + 1)
    textArea.replaceRange("", from, to, "server!!!");
    updateCaret("delete");
  }
}
function updateCaret(action){
  var update;
  if (action === "insert"){
    update = function(x) {return x + 1;};
  } else if (action === "delete") {
    update = function(x){return x - 1};
  }
  var caret = textArea.indexFromPos(textArea.getCursor());
  var newCaret = caret;
  if (caret > location) {
      newCaret = update(caret);
  }
  textArea.setCursor(textArea.posFromIndex(newCaret));
}
woot.ports.sendNewStringUpdatesPort.subscribe(stringUpdate);
function stringUpdate(str){

}
setInterval(function(){
  console.log(textArea.indexFromPos(textArea.getCursor()))
}, 500);
var sendUpdate = function(){
    if (woot === undefined 
      || woot.ports === undefined 
      || textArea === undefined 
      || textArea.value === undefined) 
    {
      return
    }
  var currString = textArea.value;
  var cp = textArea.indexFromPos(textArea.getCursor);
  var toSend = {len: currString.length
                , cp: cp
                , str: currString}
  woot.ports.TUpdatePort.send(toSend);
}
getCaretPosition = function(){

}
</script>
</body>
</html>
