<!DOCTYPE html>
  <head> 

  </head>
<body>
<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="public/lib/codemirror.js"></script>

<link rel="stylesheet" href="public/lib/codemirror.css">
<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>


<style>
.other {
  color: "#7f00ff";
}
</style>
<div id="anchor"> </div>

<script src="public/elm.js"></script>
<script>

var url = window.location.href;
var final_url = url.substr(url.lastIndexOf('/') + 1);
console.log(final_url);
var peer;
var peer_id;
var connections = {};

$(document).ready(function(e){


handleData = function(data){
  console.log("curr fellows", connections);
  if (data === undefined){
    return;
  }
  if (data.data_type === "member_update") {
    //console.log("members", data.members)
    for (var i = 0; i < data.members.length; i++) {
      var id = data.members[i]
      if (id === peer_id) {
        continue;
      }
      console.log("adding", id, connections[id]);
      if (connections[id] === undefined) {
          var conn = peer.connect(id);
          handleConnection(conn);
      }
    }
  }
  if (data.data_type === "woot_peer_update"){
    if (data.woot_data){
      console.log("sending to elm", data.woot_data);
      woot.ports.incomingPeer.send(JSON.stringify(data.woot_data));

    }
  }
}



broadcast = function(msg){
  console.log("fellow ids",  connections);
  for (key in connections) {
    console.log("key", key, connections[key]);
    if (connections[key] === undefined) {
      continue;
    }
    console.log("sending broadcast", key, "    ",  msg);
    connections[key].send(msg);
  }
}

handleConnection = function(conn) {
  var conn_id = conn.peer;
  if (conn_id === peer_id) {
    return;
  }
  if (connections[conn_id] === undefined){
    connections[conn_id] = conn;
  }


  //console.log("handle connect: ", conn);
  conn.on('open', function (){

      console.log("connected with peer: ", conn.peer);
      var members = Object.keys(connections).concat([peer_id])

      console.log("members sending", members);

      initialData = {
        peer_id: peer_id,
        members: members,
        data_type: "member_update"

      };


      conn.send(initialData);

      conn.on('data', function(data){
          console.log("got data", data);
          handleData(data);

      });

  })

}


  //console.log("e is ", e);
  // e.preventDefault();

  $.ajax({url: "/docs/" + final_url, success: function(result) {

          var peer_info = JSON.parse(result);
          peer_id = peer_info.doc_id.toString() + "-"+ peer_info.site_id.toString();
          peer = new Peer(peer_id, {host: 'localhost', port: 9000, path: '/myapp'});
          console.log(peer);
          var siteIdUpdate = [{"type": "SiteId"
                            , "siteId": peer_info.site_id}];
          woot.ports.incomingPeer.send(JSON.stringify(siteIdUpdate));



          if (peer === undefined ) {
            return;
          }
          for (var i = 0; i < peer_info.members.length; i++) {
            var fellow_id = peer_info.doc_id.toString() + "-" + peer_info.members[i].toString();

            if (fellow_id === peer_id) {
              continue;
            }

            var conn = peer.connect(fellow_id);
            handleConnection(conn);

          }

      peer.on('connection',function(conn){  
         handleConnection(conn);  
        });

          // now you want to message all your peers telling them that you have 

        } 
  });


});







var div = document.getElementById('anchor');
var woot = Elm.embed(Elm.TUpdate, div, {tUpdatePort: JSON.stringify({"type": "Insert", "cp": 1, "ch": "a"})
                    , windowLocPort: window.location.origin, incomingPeer: JSON.stringify({})});
var textAreaOld = document.getElementById('TUpdateZone');
var textArea = CodeMirror(document.body)
var colors = ["#80ff00", "#7f00ff", "#ff8000"];
var userColors = {};








textArea.on("change", function (i, c){
  //console.log("omg! ", c);
  if (c.origin != "+input" && c.origin != "+delete" && c.origin != "paste"){
    return;
  }
  var toSend = {};
  var cursor = textArea.getCursor();
  var cp = textArea.indexFromPos(cursor);
  if (c.origin === "paste") {
    toSend["type"] = "InsertString";
    toSend["str"] = c.text[0];
    cp = textArea.indexFromPos(c.from) + 1;
  }
  else if (c.removed[0] != ""){
    toSend["type"] = "Delete";
    currString = textArea.getValue();
    toSend["ch"] = c.removed[0]
  }
  else if (c['text'][0] != ""){
      toSend["type"] = "Insert";
      console.log("letter", c.text[0]);
      toSend["ch"] = c.text[0];
      cp = cp - 1;
  }
  else if (c['text'].length === 2){
      toSend["type"] = "Insert";
      toSend["ch"] = "\n";
  }
  toSend.cp = cp;

  woot.ports.tUpdatePort.send(JSON.stringify(toSend));
 
});
/// to do !! figure out an easy way to get an event when the USER deletes something from the text area.. not if it's programmatically deleted

woot.ports.sendUpdatesPortPeer.subscribe(sendPeerUpdates);

function sendPeerUpdates(msg) {
  console.log("send Peer Updates", msg);

  var message = JSON.parse(msg);
  if (message.length === 0) {return; }
  var toSend = {data_type: "woot_peer_update", woot_data: message}
  broadcast(toSend);

}





woot.ports.docUpdatesPort.subscribe(docUpdate);
function docUpdate(str){
  var docUpdates = JSON.parse(str);
  //console.log("REGISTERING server Update", docUpdates);
  if (docUpdates === undefined || docUpdates.length === 0){
    return;
  }
  for (var i = 0; i< docUpdates.length; i++ ) {
    var docUpdate = docUpdates[i];
  
  if (docUpdate["type"] === "typingInsert" ){
    if (docUpdate["ch"] === undefined || docUpdate["index"] === undefined){
      return;
    }
    var location = docUpdate["index"];
    var from = textArea.posFromIndex(location);
    textArea.replaceRange(docUpdate["ch"], from, null, "server!!!");
    var to = textArea.posFromIndex(location + 1);
    //console.log("from", from, "to", to);
    textArea.markText(from, to, {css: "color: blue"});
    updateCaret("insert");
  }
  else if (docUpdate["type"] === "typingDelete"){
    if (docUpdate["ch"] === undefined || docUpdate["index"] === undefined){
      return;
    }
    var location = docUpdate["index"];
    var from = textArea.posFromIndex(location)
    var to = textArea.posFromIndex(location + 1)
    textArea.replaceRange("", from, to, "server!!!");
    updateCaret("delete");
  }
}
}
function updateCaret(action){
  var update;
  if (action === "insert"){
    update = function(x) {return x + 1;};
  } else if (action === "delete") {
    update = function(x){return x - 1};
  }
  var caret = textArea.indexFromPos(textArea.getCursor());
  var newCaret = caret;
  if (caret > location) {
      newCaret = update(caret);
  }
  textArea.setCursor(textArea.posFromIndex(newCaret));
}
woot.ports.sendNewStringUpdatesPort.subscribe(stringUpdate);
function stringUpdate(str){

}
// setInterval(function(){
//   console.log(textArea.indexFromPos(textArea.getCursor()))
// }, 500);
var sendUpdate = function(){
    if (woot === undefined 
      || woot.ports === undefined 
      || textArea === undefined 
      || textArea.value === undefined) 
    {
      return
    }
  var currString = textArea.value;
  var cp = textArea.indexFromPos(textArea.getCursor);
  var toSend = {len: currString.length
                , cp: cp
                , str: currString}
  woot.ports.TUpdatePort.send(toSend);
}
getCaretPosition = function(){

}
</script>
</body>
</html>
