<!DOCTYPE html>
  <head> 
  Types
  </head>
<body>
<script src="public/lib/codemirror.js"></script>
<link rel="stylesheet" href="public/lib/codemirror.css">
<div id="anchor"> </div>
<textarea id="typingZone"></textarea>

<script src="public/elm.js"></script>
<script>
var div = document.getElementById('anchor');
var woot = Elm.embed(Elm.Typing, div, {typingPort: {cp: 0, str: "", len: 0}
										, windowLocPort: window.location.origin});
var textAreaOld = document.getElementById('typingZone');
var textArea = CodeMirror.fromTextArea(textAreaOld);
// var letters = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"];
// var letterInd = 0;

textArea.on("change", function(i, c){

	//console.log("omg!!", c);
	if (c.removed[0] != ""){
		currString = textArea.getValue();
	}
	if (c['text'][0] != 0){
		inserted = c.text[0];
		currString = textArea.getValue();
	}
	console.log("curr string", currString);

	console.log(textArea.indexFromPos(c.to));
	var cp = textArea.indexFromPos(textArea.getCursor());


	var toSend = {len: currString.length
								, cp: cp
								, str: currString}
	console.log("tosend is", toSend);

	woot.ports.typingPort.send(toSend);



});

getCaretPosition = function(){
	if (textArea === undefined || textArea === []) {
		console.log("text area is", textArea);
		return;
	}
	var pos = 0;
    if (document.selection) {
    	textArea.focus ();
    	var Sel = document.selection.createRange();
    	var SelLength = document.selection.createRange().text.length;
    	Sel.moveStart ('character', -textArea.value.length);
    	pos = Sel.text.length - SelLength;
    }
    //Firefox support
    else if (textArea.selectionStart || textArea.selectionStart == '0')
    	pos = textArea.selectionStart;
    return pos;
}


woot.ports.sendCaretUpdatesPort.subscribe(caretUpdate);

function caretUpdate(cp){

	console.log("got caret update!!!", JSON.parse(cp));
	cp = JSON.parse(cp);
	if (cp != undefined && cp["type"] != undefined && cp["type"] === "Caret"){
		if (cp['pos'] != undefined){
			console.log("caret before: ", getCaretPosition());
			//textArea.setSelectionRange(cp.pos, cp.pos)
			console.log("caret after:", getCaretPosition());
		}
	}

}
woot.ports.sendNewStringUpdatesPort.subscribe(stringUpdate);

function stringUpdate(str){

	console.log("got string update!!!");
	var stringUpdate = JSON.parse(str);
	console.log(stringUpdate);
//	textArea.setValue(str);

	///sendNewStringUpdatesPort

}


// function addLetter(){
// 	letterInd = (letterInd + 1) % letters.length;
// 	textArea.value = letters[letterInd] + textArea.value

// }



var sendUpdate = function(){
    if (woot === undefined 
    	|| woot.ports === undefined 
    	|| textArea === undefined 
    	|| textArea.value === undefined) 
    {
    	return
    }
	var currString = textArea.value;
	var cp = textArea.indexFromPos(textArea.getCursor);


	var toSend = {len: currString.length
								, cp: cp
								, str: currString}
	woot.ports.typingPort.send(toSend);
}

//  textArea.oninput = function(e){
//  	console.log("received input!!");
//  	sendUpdate(200);

// }

// textArea.onkeydown = function(e){
// 	var charCode = e.keyCode || e.which;
// 	if (charCode >=37 && charCode <= 40){
// 		window.setTimeout(sendUpdate, 150);
// 	}
// }



// window.onmousedown = function(e){
// 	console.log("on mousedown");
// 	//e.stopPropagation();
// //	window.setTimeout(sendUpdate, 100);
// }


</script>
</body>
</html>