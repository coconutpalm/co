<!DOCTYPE html>
  <head> 
  Types
  </head>
<body>
<div id="anchor"> </div>
  <script src="public/elm.js"></script>

<script>
var div = document.getElementById('anchor');
var woot = Elm.embed(Elm.Typing, div, {typingPort: {cp: 0, str: "", len: 0}});
var textArea = document.getElementById('typingZone');


getCaretPosition = function(){
	if (textArea === undefined || textArea === []) {
		console.log("text area is", textArea);
		return;
	}
	var pos = 0;
    if (document.selection) {
    	textArea.focus ();
    	var Sel = document.selection.createRange();
    	var SelLength = document.selection.createRange().text.length;
    	Sel.moveStart ('character', -textArea.value.length);
    	pos = Sel.text.length - SelLength;
    }
    //Firefox support
    else if (textArea.selectionStart || textArea.selectionStart == '0')
    	pos = textArea.selectionStart;
    return pos;
}



var sendUpdate = function(){
    if (woot === undefined 
    	|| woot.ports === undefined 
    	|| textArea === undefined 
    	|| textArea.value === undefined) 
    {
    	return
    }
	var currString = textArea.value;
	var cp = getCaretPosition();
	if (cp === undefined){
		return;
	}
	var toSend = {len: currString.length
								, cp: cp
								, str: currString}
	woot.ports.typingPort.send(toSend);
}

 textArea.oninput = function(e){
 	console.log("received input!!");
 	sendUpdate(200);

}

textArea.onkeydown = function(e){
	var charCode = e.keyCode || e.which;
	if (charCode >=37 && charCode <= 40){
		window.setTimeout(sendUpdate, 150);
	}
}



window.onmousedown = function(e){
	console.log("on mousedown");
	//e.stopPropagation();
//	window.setTimeout(sendUpdate, 100);
}


</script>
</body>
</html>